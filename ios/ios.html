<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Restaurant Manager iOS Apps</title>
</head>
<body>
<h2>Restaurant Manager iOS Apps</h2>
<h3>RM Kiosk</h3>
<table width="300" border="2">
  <tbody>
    <tr>
      <td><table width="300" border="0">
        <tbody>
          <tr>
            <td><strong>RM Kiosk 2019.09260</strong></td>
          </tr>
          <tr>
            <td><em>Latest Version</em></td>
          </tr>
          <tr>
            <td>Supports iOS 8-12</td>
          </tr>
        </tbody>
      </table></td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
</body>
<script>

// userAgentString is used to determine our environment

const userAgentString = navigator.userAgent;

// Device type--iPad, iPod, iPhone or other.

const DEVICE_OTHER = 0;
const DEVICE_IPAD = 1;
const DEVICE_IPOD = 2;
const DEVICE_IPHONE = 3;
const DEVICE_TESTING = DEVICE_OTHER;

var deviceType;

function determineDeviceType() {
	if (userAgentString.indexOf("iPad") != -1)
		return DEVICE_IPAD;
	if (userAgentString.indexOf("iPod") != -1)
		return DEVICE_IPOD;
	if (userAgentString.indexOf("iPhone") != -1)
		return DEVICE_IPHONE;
	return DEVICE_TESTING;
}

function deviceTypeName() {
	if (deviceType == DEVICE_IPAD)
		return "iPad";
	if (deviceType == DEVICE_IPOD)
		return "iPod";
	if (deviceType == DEVICE_IPHONE)
		return "iPhone";
	return "Other"
}

//	Form--iPad or iPod/iPhone

const FORM_OTHER = DEVICE_OTHER;
const FORM_IPAD = DEVICE_IPAD;
const FORM_IPOD = DEVICE_IPOD;

var deviceForm;

function determineDeviceForm() {
	return (deviceType == DEVICE_IPHONE) ? FORM_IPOD : deviceType;
}

//	iosVersion--version of ios

var iosVersion;

function determineVersion() {
    var v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
    return [parseInt(v[1], 10), parseInt(v[2], 10), parseInt(v[3] || 0, 10)];
}

//	Utility functions

function isSafari() {
	if (userAgentString.indexOf("Safari") == -1) {
		return false;
	}
	return userAgentString.indexOf("Chrome") == -1;
}

//	makeAParagraph -- embeds a string in paragraph html

function makeAParagraph(s) {
	return "<p>" + s + "</p>"
}

//	formatVersion

function formatVersion(version) {
	var result = "" + version[0];
	if ((version[1] != 0) || (version[2] != 0)) {
		result += "." + version[1];
		if (version[2] != 0)
			result += "." + version[2];
	}
	return result;
}

//	function buildRMKiosk()
//
//	Returns section for RM Kiosk

function buildRMKiosk() {
	var result =  "<h3>RM Kiosk</h3>";
	if (deviceForm == FORM_IPAD) {
		if (iosVersion[0] < 8)
			return result + makeAParagraph("RM Kiosk requires iOS version 8 or later");
		if (iosVersion[0] > 12)
			return result + makeAParagraph("RM Kiosk currently does not run on iOS versions greater than 12");
		const link = "itms-services://?action=download-manifest&url=https://s3.amazonaws.com/dealerdownloads/IOS/pub/rmk_manifest.plist";
		var versions = buildTableEntry("RM Kiosk", "2019.09260", "Current version", 8, 12, link);
		result += wrapInTable(300, 2, versions);
	} else {
		result += makeAParagraph("RM Kiosk only runs on an iPad");
	}
	return result;
}

//	function buildTableEntry
//
//	Returns a table entry for a single product version

function buildTableEntry(label, version, description, lowVersion, highVersion, link) {
	var versionName = label + " " + version;
	if (link != "")
		versionName = wrapInLink(versionName, link);
	var result = "<td><strong>" + versionName + "</strong></td>";
	result += "</tr>";
	result += "<tr><td><em>" + description + "</em></td></tr>";
	result += "<tr><td>Supports " + getSupportRange(lowVersion, highVersion) + "</td></tr>";
	return "<tr><td>" + wrapInTable(300, 0, result) + "</td></tr>"
}

function wrapInTable(width, border, body) {
	var result = "<table width=\"" + width + "\" border=\"" + border + "\"><tbody>" + body + "</tbody></table>";
	return result;
}

function wrapInLink(data,link) {
	return "<a href=\"" + link + "\">" + data + "</a>";
}

function getSupportRange(lowVersion, highVersion) {
	if (lowVersion == 0) {
		if (highVersion == 99)
			return "All iOS Versions";
		return "iOS Versions < " + highVersion;
	}
	if (highVersion == 99) {
		return "iOS Versions > " + lowVersion;
	}
	return "iOS Versions " + lowVersion + "-" + highVersion;
}

//	function buildPage()
//
//	Returns the body for our page

function buildPage() {
	deviceType = determineDeviceType();
	if (deviceType == DEVICE_OTHER)
		return makeAParagraph("This page can only be used to install apps while running in Safari on an iOS device");
	if (!isSafari())
		return makeAParagraph("To install apps from this page, load the page in Safari on your iOS device");
	deviceForm = determineDeviceForm();
	iosVersion = determineVersion();
	console.log(iosVersion);
	var result = "<h2>Restaurant Manager iOS Apps</h2>";
	result += "<h4>Device: " + deviceTypeName() + ". iOS Version: " + formatVersion(iosVersion) + "</h4>";
	result += buildRMKiosk();
	return result;
}

document.body.innerHTML = buildPage();

</script>
</html>
